# ğŸ“š 14ì¥ ì¼ê´€ì„± ìˆëŠ” í˜‘ë ¥

ê°ì²´ëŠ” í˜‘ë ¥ì„ ìœ„í•´ ì¡´ì¬í•œë‹¤.

## ğŸ“– 14.1 í•¸ë“œí° ê³¼ê¸ˆ ì‹œìŠ¤í…œ ë³€ê²½í•˜ê¸°

### ğŸ”– 14.1.1 ê¸°ë³¸ ì •ì±… í™•ì¥

ê¸°ë³¸ ì •ì±…ì„ êµ¬ì„±í•˜ëŠ” 4ê°€ì§€ ë°©ì‹

1. ê³ ì •ìš”ê¸ˆ ë°©ì‹
2. ì‹œê°„ëŒ€ë³„ ë°©ì‹
3. ìš”ì¼ë³„ ë°©ì‹
4. êµ¬ê°„ë³„ ë°©ì‹

### ğŸ”– 14.1.2 ê³ ì •ìš”ê¸ˆ ë°©ì‹ êµ¬í˜„í•˜ê¸°

```java
@RequiredArgsConstructor
public class FixedFeePolicy extends BasicRatePolicy {

    private final Money amount;
    private final Duration seconds;

    @Override
    protected Money calculateCallFee(Call call) {
        return amount.times((double) call.getDuration().getSeconds() / seconds.getSeconds());
    }
}
```

### ğŸ”– 14.1.3 ì‹œê°„ëŒ€ë³„ ë°©ì‹ êµ¬í˜„í•˜ê¸°

```java
@Getter
@RequiredArgsConstructor
public class DateTimeInterval {

    private final LocalDateTime from;
    private final LocalDateTime to;

    public static DateTimeInterval of(LocalDateTime from, LocalDateTime to) {
        return new DateTimeInterval(from, to);
    }

    public static DateTimeInterval toMidnight(LocalDateTime from) {
        return new DateTimeInterval(
                from,
                LocalDateTime.of(from.toLocalDate(), LocalTime.of(23, 59, 59, 999_999_999)));
    }

    public static DateTimeInterval fromMidnight(LocalDateTime to) {
        return new DateTimeInterval(
                LocalDateTime.of(to.toLocalDate(), LocalTime.of(0, 0)),
                to);
    }

    public static DateTimeInterval during(LocalDate date) {
        return new DateTimeInterval(
                LocalDateTime.of(date, LocalTime.of(0, 0)),
                LocalDateTime.of(date, LocalTime.of(23, 59, 59, 999_999_999)));
    }

    public Duration duration() {
        return Duration.between(from, to);
    }
    
    public List<DateTimeInterval> splitByDay() {
        if (days() > 0) {
            return splitByDay(days());
        }
        
        return List.of(this);
    }
    
    private long days() {
        return Duration.between(from.toLocalDate().atStartOfDay(), to.toLocalDate().atStartOfDay()).toDays();
    }
    
    private List<DateTimeInterval> splitByDay(long days) {
        List<DateTimeInterval> result = new ArrayList<>();
        
        addFirstDay(result);
        addMiddleDays(result, days);
        addLastDay(result);
        
        return result;
    }
    
    private void addFirstDay(List<DateTimeInterval> result) {
        result.add(DateTimeInterval.toMidnight(from));
    }
    
    private void addMiddleDays(List<DateTimeInterval> result, long days) {
        for (int loop = 1; loop < days; loop++) {
             result.add(DateTimeInterval.during(from.toLocalDate().plusDays(loop)));
        }
    }
    
    private void addLastDay(List<DateTimeInterval> result) {
        result.add(DateTimeInterval.fromMidnight(to));
    }
}
```

```java
public class Call {

    @Getter
    private final DateTimeInterval interval;

    public Call(LocalDateTime from, LocalDateTime to) {
        this.interval = DateTimeInterval.of(from, to);
    }

    public Duration getDuration() {
        return interval.duration();
    }

    public LocalDateTime getFrom() {
        return interval.getFrom();
    }

    public LocalDateTime getTo() {
        return interval.getTo();
    }

    public List<DateTimeInterval> splitByDay() {
        return interval.splitByDay();
    }
}
```

```java
public class TimeOfDayDiscountPolicy extends BasicRatePolicy {

    private List<LocalTime> starts = new ArrayList<>();
    private List<LocalTime> ends = new ArrayList<>();
    private List<Duration> durations = new ArrayList<>();
    private List<Money> amounts = new ArrayList<>();

    @Override
    protected Money calculateCallFee(Call call) {
        Money result = Money.ZERO;
        for (DateTimeInterval interval : call.splitByDay()) {
            for (int loop = 0; loop < starts.size(); loop++) {
                result.plus(amounts.get(loop).times(
                        (double) Duration.between(from(interval, starts.get(loop)), to(interval, ends.get(loop)))
                                .getSeconds() / durations.get(loop).getSeconds()));
            }
        }
        return result;
    }

    private LocalTime from(DateTimeInterval interval, LocalTime from) {
        return interval.getFrom().toLocalTime().isBefore(from) ? from : interval.getFrom().toLocalTime();
    }

    private LocalTime to(DateTimeInterval interval, LocalTime to) {
        return interval.getTo().toLocalTime().isAfter(to) ? to : interval.getTo().toLocalTime();
    }
}
```

### ğŸ”– 14.1.4 ìš”ì¼ë³„ ë°©ì‹ êµ¬í˜„í•˜ê¸°

```java
@RequiredArgsConstructor
public class DayOfWeekDiscountRule {
    
    private final List<DayOfWeek> dayOfWeeks = new ArrayList<>();
    private final Duration duration = Duration.ZERO;
    private final Money amount = Money.ZERO;
    
    public Money calculate(DateTimeInterval interval) {
        if (dayOfWeeks.contains(interval.getFrom().getDayOfWeek())) {
            return amount.times((double) interval.duration().getSeconds() / duration.getSeconds());
        }
        
        return Money.ZERO;
    }
}
```

```java
@RequiredArgsConstructor
public class DayOfWeekDiscountPolicy extends BasicRatePolicy {

    private final List<DayOfWeekDiscountRule> rules = new ArrayList<>();

    @Override
    protected Money calculateCallFee(Call call) {
        Money result = Money.ZERO;

        for (DateTimeInterval interval : call.getInterval().splitByDay()) {
            for (DayOfWeekDiscountRule rule : rules) {
                result.plus(rule.calculate(interval));
            }
        }
        
        return result;
    }
}
```

### ğŸ”– 14.1.5 êµ¬ê°„ë³„ ë°©ì‹ êµ¬í˜„í•˜ê¸°

```java
public class DurationDiscountRule extends FixedFeePolicy {

    private final Duration from;
    private final Duration to;

    public DurationDiscountRule(Money amount, Duration seconds, Duration from, Duration to) {
        super(amount, seconds);
        this.from = from;
        this.to = to;
    }

    public Money calculate(Call call) {
        if (call.getDuration().compareTo(to) > 0) {
            return Money.ZERO;
        }

        if (call.getDuration().compareTo(from) < 0) {
            return Money.ZERO;
        }
        
        return super.calculateCallFee(new Call(call.getFrom().plus(from),
                call.getDuration().compareTo(to) > 0 ? call.getFrom().plus(to) : call.getTo()));
    }
}
```

- ìƒì†ì„ ì˜ëª» ì‚¬ìš©í–ˆë‹¤! ì˜ˆì‹œì½”ë“œë¥¼ ë°”ê¿”ì„œ ë„£ì–´ë´„.

```java
@RequiredArgsConstructor
public class DurationDiscountPolicy extends BasicRatePolicy {

    private final List<DurationDiscountRule> rules = new ArrayList<>();

    @Override
    protected Money calculateCallFee(Call call) {
        Money result = Money.ZERO;
        for (DurationDiscountRule rule : rules) {
            result.plus(rule.calculate(call));
        }
        return result;
    }
}
```

- ì´í•´í•˜ê¸°ë„ í˜ë“¤ê³  ì„¤ê³„ ê°œì„ ê³¼ ìƒˆë¡œìš´ ê¸°ëŠ¥ì˜ ì¶”ê°€ë¥¼ ë°©í•´í•œë‹¤.
- ì½”ë“œ ì¬ì‚¬ìš©ì„ ìœ„í•œ ìƒì†ì€ í•´ë¡­ë‹¤.

## ğŸ“– 14.2 ì„¤ê³„ì— ì¼ê´€ì„± ë¶€ì—¬í•˜ê¸°

í˜‘ë ¥ì„ ì¼ê´€ì„± ìˆê²Œ ë§Œë“¤ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ë³¸ ì§€ì¹¨ì„ ë”°ë¥´ì.

1. ë³€í•˜ëŠ” ê°œë…ì„ ë³€í•˜ì§€ ì•ŠëŠ” ê°œë…ìœ¼ë¡œë¶€í„° ë¶„ë¦¬í•˜ë¼.
2. ë³€í•˜ëŠ” ê°œë…ì„ ìº¡ìŠí™”í•˜ë¼.

### ğŸ”– 14.2.1 ì¡°ê±´ ë¡œì§ ëŒ€ ê°ì²´ íƒìƒ‰

```java
public abstract class DiscountPolicy {
    private final List<DiscountCondition> conditions;

    protected DiscountPolicy(DiscountCondition... conditions) {
        this.conditions = Arrays.asList(conditions);
    }

    public Money calculateDiscountAmount(Screening screening) {
        for (DiscountCondition condition : conditions) {
            if (condition.isSatisfiedBy(screening)) {
                return getDiscountAmount(screening);
            }
        }
        return Money.ZERO;
    }
    protected abstract Money getDiscountAmount(Screening screening);
}
```

```java
@AllArgsConstructor
public class Movie {

    /**
     * ì œëª©
     */
    private String title;

    /**
     * ìƒì˜ì‹œê°„
     */
    private Duration runningTime;

    /**
     * ê¸°ë³¸ìš”ê¸ˆ
     */
    @Getter
    private Money fee;

    /**
     * í• ì¸ ì •ì±…
     */
    private DiscountPolicy discountPolicy;

    public Money calculateMovieFee(Screening screening) {
        return fee.minus(discountPolicy.calculateDiscountAmount(screening));
    }

    public void changeDiscountPolicy(DiscountPolicy discountPolicy) {
        this.discountPolicy = discountPolicy;
    }
}
```

- ì‹¤ì œë¡œ í˜‘ë ¥ì— ì°¸ì—¬í•˜ëŠ” ì£¼ì²´ëŠ” êµ¬ì²´ì ì¸ ê°ì²´ë‹¤.
- ë³€ê²½ì— ì´ˆì ì„ ë§ì¶”ê³  ìº¡ìŠí™”ì˜ ê´€ì ì—ì„œ ì„¤ê³„ë¥¼ ë°”ë¼ë³´ë©´ ì¼ê´€ì„± ìˆëŠ” í˜‘ë ¥ íŒ¨í„´ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

### ğŸ”– 14.2.2 ìº¡ìŠí™” ë‹¤ì‹œ ì‚´í´ë³´ê¸°

ë°ì´í„° ì€ë‹‰

- ì˜¤ì§ ì™¸ë¶€ì— ê³µê°œëœ ë©”ì„œë“œë¥¼ í†µí•´ì„œë§Œ ê°ì²´ì˜ ë‚´ë¶€ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ì œí•œí•¨ìœ¼ë¡œì¨ ê°ì²´ ë‚´ë¶€ì˜ ìƒíƒœ êµ¬í˜„ì„ ìˆ¨ê¸°ëŠ” ê¸°ë²•
- í•´ë‹¹ í´ë˜ìŠ¤ì˜ ë©”ì„œë“œë§Œì´ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
- ìº¡ìŠí™”ëŠ” ë°ì´í„° ì€ë‹‰ ì´ìƒì´ë‹¤.

> ìº¡ìŠí™”ë€ ë³€í•˜ëŠ” ì–´ë–¤ ê²ƒì´ë“  ê°ì¶”ëŠ” ê²ƒì´ë‹¤.

- ë°ì´í„° ìº¡ìŠí™”
- ë©”ì„œë“œ ìº¡ìŠí™”
- ê°ì²´ ìº¡ìŠí™”
- ì„œë¸Œíƒ€ì… ìº¡ìŠí™”

ë³€ê²½ì„ ìº¡ìŠí™”í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì´ ì¡´ì¬í•˜ì§€ë§Œ í˜‘ë ¥ì„ ì¼ê´€ì„± ìˆê²Œ ë§Œë“¤ê¸° ìœ„í•´ ê°€ì¥ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ì„œë¸Œíƒ€ì… ìº¡ìŠí™”ì™€ ê°ì²´ ìº¡ìŠí™”ë¥¼ ì¡°í•©í•˜ëŠ” ê²ƒì´ë‹¤.

- ë³€í•˜ëŠ” ë¶€ë¶„ì„ ë¶„ë¦¬í•´ì„œ íƒ€ì… ê³„ì¸µì„ ë§Œë“ ë‹¤.
- ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì˜ ì¼ë¶€ë¡œ íƒ€ì… ê³„ì¸µì„ í•©ì„±í•œë‹¤.

## ğŸ“– 14.3 ì¼ê´€ì„± ìˆëŠ” ê¸°ë³¸ ì •ì±… êµ¬í˜„í•˜ê¸°

### ğŸ”– 14.3.1 ë³€ê²½ ë¶„ë¦¬í•˜ê¸°

- ê³ ì •ìš”ê¸ˆ ë°©ì‹
  - ë‹¨ìœ„ì‹œê°„ë‹¹ ìš”ê¸ˆ
- ì‹œê°„ëŒ€ë³„ ë°©ì‹
  - ì‹œì‘ì‹œê°„ ~ ì¢…ë£Œì‹œê°„ê¹Œì§€ ë‹¨ìœ„ì‹œê°„ë‹¹ ìš”ê¸ˆ
- ìš”ì¼ë³„ ë°©ì‹
  - ìš”ì¼ë³„ ë‹¨ìœ„ì‹œê°„ë‹¹ ìš”ê¸ˆ
- êµ¬ê°„ë³„ ë°©ì‹
  - í†µí™”êµ¬ê°„ë™ì•ˆ ë‹¨ìœ„ì‹œê°„ë‹¹ ìš”ê¸ˆ

### ğŸ”– 14.3.2 ë³€ê²½ ìº¡ìŠí™”í•˜ê¸°

- ë³€í•˜ëŠ” ê²ƒ: ì ìš©ì¡°ê±´
- ë³€í•˜ì§€ ì•ŠëŠ” ê²ƒ: ê·œì¹™

ê·œì¹™ìœ¼ë¡œë¶€í„° ì ìš©ì¡°ê±´ì„ ë¶„ë¦¬í•´ì„œ ì¶”ìƒí™”í•œ í›„ ì‹œê°„ëŒ€ë³„, ìš”ì¼ë³„, êµ¬ê°„ë³„ ë°©ì‹ì„ ì´ ì¶”ìƒí™”ì˜ ì„œë¸Œíƒ€ì…ìœ¼ë¡œ ë§Œë“ ë‹¤.

### ğŸ”– 14.3.3 í˜‘ë ¥ íŒ¨í„´ ì„¤ê³„í•˜ê¸°

1. ì ìš©ì¡°ê±´ì„ ê°€ì¥ ì˜ ì•Œê³  ìˆëŠ” ì •ë³´ ì „ë¬¸ê°€ì¸ `FeeCondition`ì—ê²Œ í• ë‹¹
2. ë‹¨ìœ„ìš”ê¸ˆì„ ì ìš©í•´ì„œ ìš”ê¸ˆì„ ê³„ì‚°í•˜ëŠ” ë‘ ë²ˆì§¸ ì‘ì—…ì€ ìš”ê¸ˆê¸°ì¤€ì˜ ì •ë³´ ì „ë¬¸ê°€ì¸ `FeeRule`ì´ ë‹´ë‹¹

### ğŸ”– 14.3.4 ì¶”ìƒí™” ìˆ˜ì¤€ì—ì„œ í˜‘ë ¥ íŒ¨í„´ êµ¬í˜„í•˜ê¸°

```java
public interface FeeCondition {
    
    List<DateTimeInterval> findTimeIntervals(Call call);
}
```

```java
@RequiredArgsConstructor
public class FeePerDuration {

    private final Money fee;

    private final Duration duration;

    public Money calculate(DateTimeInterval interval) {
        return fee.times(Math.ceil((double) interval.duration().toNanos() / duration.toNanos()));
    }
}
```

```java
@RequiredArgsConstructor
public class FeeRule {

    private final FeeCondition feeCondition;

    private final FeePerDuration feePerDuration;

    public Money calculateFee(Call call) {
        return feeCondition.findTimeIntervals(call)
                .stream()
                .map(feePerDuration::calculate)
                .reduce(Money.ZERO, Money::plus);
    }
}
```

```java
@RequiredArgsConstructor(access = AccessLevel.PROTECTED)
public abstract class BasicRatePolicy implements RatePolicy {

    private final List<FeeRule> feeRules;

    @Override
    public Money calculateFee(Phone phone) {
        return phone.getCalls()
                .stream()
                .map(this::calculate)
                .reduce(Money.ZERO, Money::plus);
    }

    private Money calculate(Call call) {
        return feeRules.stream()
                .map(rule -> rule.calculateFee(call))
                .reduce(Money.ZERO, Money::plus);
    }

    protected abstract Money calculateCallFee(Call call);
}
```

- ë³€í•˜ì§€ ì•ŠëŠ” ìš”ì†Œì™€ ì¶”ìƒì ì¸ ìš”ì†Œë§Œìœ¼ë¡œë„ ìš”ê¸ˆ ê³„ì‚°ì— í•„ìš”í•œ ì „ì²´ì ì¸ í˜‘ë ¥ êµ¬ì¡°ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.

### ğŸ”– 14.3.5 êµ¬ì²´ì ì¸ í˜‘ë ¥ êµ¬í˜„í•˜ê¸°

#### ğŸ› ï¸ ì‹œê°„ëŒ€ë³„ ì •ì±…

```java
@RequiredArgsConstructor
public class TimeOfDayFeeCondition implements FeeCondition {

    private final LocalTime from;
    private final LocalTime to;

    @Override
    public List<DateTimeInterval> findTimeIntervals(Call call) {
        return call.getInterval().splitByDay()
                .stream()
                .filter(each -> from(each).isBefore(to(each)))
                .map(each -> DateTimeInterval.of(
                        LocalDateTime.of(each.getFrom().toLocalDate(), from(each)),
                        LocalDateTime.of(each.getTo().toLocalDate(), to(each))))
                .collect(toList());
    }

    public LocalTime from(DateTimeInterval interval) {
        return interval.getFrom().toLocalTime().isBefore(from) ? from : interval.getFrom().toLocalTime();
    }

    public LocalTime to(DateTimeInterval interval) {
        return interval.getTo().toLocalTime().isAfter(to) ? to : interval.getTo().toLocalTime();
    }
}
```

#### ğŸ› ï¸ ìš”ì¼ë³„ ì •ì±…

```java
@RequiredArgsConstructor
public class DayOfWeekFeeCondition implements FeeCondition {

    private final List<DayOfWeek> dayOfWeeks;

    @Override
    public List<DateTimeInterval> findTimeIntervals(Call call) {
        return call.getInterval()
                .splitByDay()
                .stream()
                .filter(each -> dayOfWeeks.contains(each.getFrom().getDayOfWeek()))
                .collect(toList());
    }
}
```

#### ğŸ› ï¸ êµ¬ê°„ë³„ ì •ì±…

```java
@RequiredArgsConstructor
public class DurationFeeCondition implements FeeCondition {

    private final Duration from;
    private final Duration to;

    @Override
    public List<DateTimeInterval> findTimeIntervals(Call call) {
        if (call.getInterval().duration().compareTo(from) < 0) {
            return Collections.emptyList();
        }

        return List.of(DateTimeInterval.of(
                call.getInterval().getFrom().plus(from),
                call.getInterval().duration().compareTo(to) > 0 ?
                        call.getInterval().getFrom().plus(to) :
                        call.getInterval().getTo()));
    }
}
```

- ìœ ì‚¬í•œ ê¸°ëŠ¥ì— ëŒ€í•´ ìœ ì‚¬í•œ í˜‘ë ¥ íŒ¨í„´ì„ ì ìš©í•˜ëŠ” ê²ƒì€ ê°ì²´ì§€í–¥ ì‹œìŠ¤í…œì—ì„œ **ê°œë…ì  ë¬´ê²°ì„±**ì„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ê°€ì¥ íš¨ê³¼ì ì¸ ë°©ë²•ì´ë‹¤.

### ğŸ”– 14.3.6 í˜‘ë ¥ íŒ¨í„´ì— ë§ì¶”ê¸°

```java
@RequiredArgsConstructor
public class FixedFeeCondition implements FeeCondition {

    @Override
    public List<DateTimeInterval> findTimeIntervals(Call call) {
        return Collections.singletonList(call.getInterval());
    }
}
```

- ê°œë…ì  ë¬´ê²°ì„±ì„ ë¬´ë„ˆëœ¨ë¦¬ëŠ” ê²ƒë³´ë‹¤ëŠ” ì•½ê°„ì˜ ë¶€ì¡°í™”ë¥¼ ìˆ˜ìš©í•˜ëŠ” í¸ì´ ë” ë‚«ë‹¤.

### ğŸ”– 14.3.7 íŒ¨í„´ì„ ì°¾ì•„ë¼

ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìœ ì‚¬í•œ ê¸°ëŠ¥ì— ëŒ€í•œ ë³€ê²½ì´ ì§€ì†ì ìœ¼ë¡œ ë°œìƒí•˜ê³  ìˆë‹¤ë©´ ë³€ê²½ì„ ìº¡ìŠí™”í•  ìˆ˜ ìˆëŠ” ì ì ˆí•œ ì¶”ìƒí™”ë¥¼ ì°¾ì€ í›„, ì´ ì¶”ìƒí™”ì— ë³€í•˜ì§€ ì•ŠëŠ” ê³µí†µì ì¸ ì±…ì„ì„ í• ë‹¹í•˜ë¼.

í˜‘ë ¥ì„ ì¼ê´€ì„± ìˆê²Œ ë§Œë“ ë‹¤ëŠ” ê²ƒì€ ìœ ì‚¬í•œ ë³€ê²½ì„ ìˆ˜ìš©í•  ìˆ˜ ìˆëŠ” í˜‘ë ¥ íŒ¨í„´ì„ ë°œê²¬í•˜ëŠ” ê²ƒê³¼ ë™ì¼í•˜ë‹¤.
